<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>IOAPIC - OSDev Wiki</title>
<meta charset="UTF-8" />
<meta name="generator" content="MediaWiki 1.18.0" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="OSDev Wiki (en)" />
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.osdev.org/api.php?action=rsd" />
<link rel="alternate" type="application/atom+xml" title="OSDev Wiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="/load.php?debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cskins.vector&amp;only=styles&amp;skin=vector&amp;*" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="/load.php?debug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*" />
<style>a:lang(ar),a:lang(ckb),a:lang(fa),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}a.new,#quickbar a.new{color:#ba0000}

/* cache key: wikidb:resourceloader:filter:minify-css:4:c88e2bcd56513749bec09a7e29cb3ffa */
</style>
<script src="/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
	mw.config.set({"wgCanonicalNamespace": "", "wgCanonicalSpecialPageName": false, "wgNamespaceNumber": 0, "wgPageName": "IOAPIC", "wgTitle": "IOAPIC", "wgCurRevisionId": 23631, "wgArticleId": 2434, "wgIsArticle": true, "wgAction": "view", "wgUserName": null, "wgUserGroups": ["*"], "wgCategories": ["Interrupts", "Multiprocessing"], "wgBreakFrames": false, "wgRestrictionEdit": [], "wgRestrictionMove": []});
}
</script><script>if(window.mw){
	mw.loader.load(["mediawiki.page.startup"]);
}
</script>
<style type="text/css">/*<![CDATA[*/
.source-cpp {line-height: normal;}
.source-cpp li, .source-cpp pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for cpp
 * CSS class: source-cpp, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.cpp.source-cpp .de1, .cpp.source-cpp .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;}
.cpp.source-cpp  {font-family:monospace;}
.cpp.source-cpp .imp {font-weight: bold; color: red;}
.cpp.source-cpp li, .cpp.source-cpp .li1 {font-weight: normal; vertical-align:top;}
.cpp.source-cpp .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.cpp.source-cpp .li2 {font-weight: bold; vertical-align:top;}
.cpp.source-cpp .kw1 {color: #0000ff;}
.cpp.source-cpp .kw2 {color: #0000ff;}
.cpp.source-cpp .kw3 {color: #0000dd;}
.cpp.source-cpp .kw4 {color: #0000ff;}
.cpp.source-cpp .co1 {color: #666666;}
.cpp.source-cpp .co2 {color: #339900;}
.cpp.source-cpp .coMULTI {color: #ff0000; font-style: italic;}
.cpp.source-cpp .es0 {color: #000099; font-weight: bold;}
.cpp.source-cpp .es1 {color: #000099; font-weight: bold;}
.cpp.source-cpp .es2 {color: #660099; font-weight: bold;}
.cpp.source-cpp .es3 {color: #660099; font-weight: bold;}
.cpp.source-cpp .es4 {color: #660099; font-weight: bold;}
.cpp.source-cpp .es5 {color: #006699; font-weight: bold;}
.cpp.source-cpp .br0 {color: #008000;}
.cpp.source-cpp .sy0 {color: #008000;}
.cpp.source-cpp .sy1 {color: #000080;}
.cpp.source-cpp .sy2 {color: #000040;}
.cpp.source-cpp .sy3 {color: #000040;}
.cpp.source-cpp .sy4 {color: #008080;}
.cpp.source-cpp .st0 {color: #FF0000;}
.cpp.source-cpp .nu0 {color: #0000dd;}
.cpp.source-cpp .nu6 {color: #208080;}
.cpp.source-cpp .nu8 {color: #208080;}
.cpp.source-cpp .nu12 {color: #208080;}
.cpp.source-cpp .nu16 {color:#800080;}
.cpp.source-cpp .nu17 {color:#800080;}
.cpp.source-cpp .nu18 {color:#800080;}
.cpp.source-cpp .nu19 {color:#800080;}
.cpp.source-cpp .me1 {color: #007788;}
.cpp.source-cpp .me2 {color: #007788;}
.cpp.source-cpp .ln-xtra, .cpp.source-cpp li.ln-xtra, .cpp.source-cpp div.ln-xtra {background-color: #ffc;}
.cpp.source-cpp span.xtra { display:block; }

/*]]>*/
</style>
<style type="text/css">/*<![CDATA[*/
@import "/index.php?title=MediaWiki:Geshi.css&usemsgcache=yes&action=raw&ctype=text/css&smaxage=18000";
/*]]>*/
</style><!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/vector/csshover.min.htc")}</style><![endif]--></head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-IOAPIC action-view skin-vector">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<!-- content -->
		<div id="content">
			<a id="top"></a>
			<div id="mw-js-message" style="display:none;"></div>
						<!-- firstHeading -->
			<h1 id="firstHeading" class="firstHeading">IOAPIC</h1>
			<!-- /firstHeading -->
			<!-- bodyContent -->
			<div id="bodyContent">
								<!-- tagline -->
				<div id="siteSub">From OSDev Wiki</div>
				<!-- /tagline -->
								<!-- subtitle -->
				<div id="contentSub"></div>
				<!-- /subtitle -->
																<!-- jumpto -->
				<div id="jump-to-nav">
					Jump to: <a href="#mw-head">navigation</a>,
					<a href="#p-search">search</a>
				</div>
				<!-- /jumpto -->
								<!-- bodycontent -->
				<div lang="en" dir="ltr" class="mw-content-ltr"><p>The Intel I/O Advanced Programmable Interrupt Controller is used to distribute external interrupts in a more advanced manner than that of the standard <a href="/8259_PIC" title="8259 PIC">8259 PIC</a>. With the I/O APIC, interrupts can be distributed to physical or logical (clusters of) processors and can be prioritized. Each I/O APIC typically handles 24 external interrupts.
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Detecting_I.2FO_APIC"><span class="tocnumber">1</span> <span class="toctext">Detecting I/O APIC</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Programming_the_I.2FO_APIC"><span class="tocnumber">2</span> <span class="toctext">Programming the I/O APIC</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#IOAPICID"><span class="tocnumber">2.1</span> <span class="toctext">IOAPICID</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#IOAPICVER"><span class="tocnumber">2.2</span> <span class="toctext">IOAPICVER</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#IOAPICARB"><span class="tocnumber">2.3</span> <span class="toctext">IOAPICARB</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#IOREDTBL"><span class="tocnumber">2.4</span> <span class="toctext">IOREDTBL</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#IOREGSEL_and_IOWIN"><span class="tocnumber">2.5</span> <span class="toctext">IOREGSEL and IOWIN</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8"><a href="#IO_APIC_Inputs"><span class="tocnumber">3</span> <span class="toctext">IO APIC Inputs</span></a></li>
<li class="toclevel-1 tocsection-9"><a href="#External_Links"><span class="tocnumber">4</span> <span class="toctext">External Links</span></a>
<ul>
<li class="toclevel-2 tocsection-10"><a href="#MP_Tables"><span class="tocnumber">4.1</span> <span class="toctext">MP Tables</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#I.2FO_APIC"><span class="tocnumber">4.2</span> <span class="toctext">I/O APIC</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h2> <span class="mw-headline" id="Detecting_I.2FO_APIC"> Detecting I/O APIC </span></h2>
<p>In order to detect the existence of an I/O APIC (or multiple ones), the Intel Multi-Processor or <a href="/RSDP" title="RSDP">ACPI</a> tables (specifically, the <a href="/MADT" title="MADT">MADT</a>) must be parsed. In the MP tables, configuration tables with the entry identification of 0x02 are for I/O APICs. Parsing will tell how many (if any) I/O APICs exist, what are their APIC ID, base MMIO address and first IRQ (or GSI - Global System Interrupt). For more information on parsing the MP tables, see the External MP Tables Links section below. So you can have, say, 2 I/O APICs, the first handling IRQs 0 - 23 and the second 24 - 47.
</p>
<h2> <span class="mw-headline" id="Programming_the_I.2FO_APIC"> Programming the I/O APIC </span></h2>
<p>Each I/O APIC has a set of 2 or 3 (depending on version) 32-bit registers and up to many 64-bit registers (one per IRQ). The 64-bit registers have actually to be accessed as two 32-bit reads/writes. All registers are memory indexed. It means that you actually have only two 32-bit registers in memory, called IOREGSEL and IOREGWIN. You put the register index in IOREGSEL, and then you can read/write in IOREGWIN. The first three registers contain general information about this I/O APIC, while the remaining registers contain the specific configuration for each IRQ.
</p>
<h3> <span class="mw-headline" id="IOAPICID"> IOAPICID </span></h3>
<p>This register has index 0 (you write 0 to IOREGSEL and then read from IOREGWIN). It's a Read-Only register with almost all bits reserved. The only interesting field is in bits 24 - 27: the APIC ID for this device (each peripheral which is interfaced with the APIC Bus needs an APIC ID, not only CPUs). You shall find this ID in ACPI/MP Tables as well.
</p>
<h3> <span class="mw-headline" id="IOAPICVER"> IOAPICVER </span></h3>
<p>This register (index 1) contains the I/O APIC Version in bits 0 - 8, and the <b>Max Redirection Entry</b> which is "how many IRQs can this I/O APIC handle - 1". It is encoded in bits 16 - 23.
</p>
<h3> <span class="mw-headline" id="IOAPICARB"> IOAPICARB </span></h3>
<p>This register (index 2) contains in bits 24 - 27 the APIC Arbitration ID. <b>TODO</b>
</p>
<h3> <span class="mw-headline" id="IOREDTBL"> IOREDTBL </span></h3>
<p>Following there are two 32-bit register for each IRQ. The first IRQ has indexes 0x10 and 0x11, the second 0x12 and 0x13, the third 0x14 and 0x15, and so on. So the <i>Redirection Entry</i> register for IRQ <i>n</i> is 0x10 + n * 2 (+ 1). In the first of the two registers you access to the LOW uint32_t / bits 31:0, and the second for the high uint32_t / 63:32. Each redirection entry is made of the following fields:
</p>
<table class="wikitable">

<tr>
<th> Field
</th>
<th> Bits
</th>
<th> Description
</th></tr>
<tr>
<td style="width: 100px;"> Vector
</td>
<td style="width: 50px;"> 0 - 7
</td>
<td> The Interrupt vector that will be raised on the specified CPU(s).
</td></tr>
<tr>
<td> Delivery Mode
</td>
<td> 8 - 10
</td>
<td> How the interrupt will be sent to the CPU(s). It can be 000 (Fixed), 001 (Lowest Priority), 010 (SMI), 100 (NMI), 101 (INIT) and 111 (ExtINT). Most of the cases you want Fixed mode, or Lowest Priority if you don't want to suspend a high priority task on some important Processor/Core/Thread.
</td></tr>
<tr>
<td> Destination Mode
</td>
<td> 11
</td>
<td> Specify how the Destination field shall be interpreted. 0: Physical Destination, 1: Logical Destination
</td></tr>
<tr>
<td> Delivery Status
</td>
<td> 12
</td>
<td> If 0, the IRQ is just relaxed and waiting for something to happen (or it has fired and already processed by Local APIC(s)). If 1, it means that the IRQ has been sent to the Local APICs but it's still waiting to be delivered.
</td></tr>
<tr>
<td> Pin Polarity
</td>
<td> 13
</td>
<td> 0: Active high, 1: Active low. For ISA IRQs assume Active High unless otherwise specified in Interrupt Source Override descriptors of the MADT or in the MP Tables.
</td></tr>
<tr>
<td> Remote IRR
</td>
<td> 14
</td>
<td> <b>TODO</b>
</td></tr>
<tr>
<td> Trigger Mode
</td>
<td> 15
</td>
<td> 0: Edge, 1: Level. For ISA IRQs assume Edge unless otherwise specified in Interrupt Source Override descriptors of the MADT or in the MP Tables.
</td></tr>
<tr>
<td> Mask
</td>
<td> 16
</td>
<td> Just like in the old PIC, you can temporary disable this IRQ by setting this bit, and reenable it by clearing the bit.
</td></tr>
<tr>
<td> Destination
</td>
<td> 56 - 63
</td>
<td> This field is interpreted according to the Destination Format bit. If Physical destination is choosen, then this field is limited to bits 56 - 59 (only 16 CPUs addressable). You put here the APIC ID of the CPU that you want to receive the interrupt. <b>TODO</b>: Logical destination format...
</td></tr></table>
<h3> <span class="mw-headline" id="IOREGSEL_and_IOWIN"> IOREGSEL and IOWIN </span></h3>
<p>The register IOREGSEL is an MMIO register select register that is used to access all the other I/O APIC registers. The IOWIN register is the 'data' register. Once the IOREGSEL register has been set, the IOWIN register can be used to write or read the register in the IOREGSEL. The actual position in memory of the two registers is specified in the ACPI MADT Table and/or in the MP table. The IOREGSEL is at the address specified, and IOREGWIN is at the same address + 0x10.
</p>
<div dir="ltr" class="mw-geshi" style="text-align: left;"><div class="cpp source-cpp"><pre class="de1"><span class="co2">#define IOAPICID          0x00</span>
<span class="co2">#define IOAPICVER         0x01</span>
<span class="co2">#define IOAPICARB         0x02</span>
<span class="co2">#define IOAPICREDTBL(n)   (0x10 + 2 * n) // lower-32bits (add +1 for upper 32-bits)</span>
&#160;
<span class="kw4">void</span> write_ioapic_register<span class="br0">&#40;</span><span class="kw4">const</span> <span class="kw4">uintptr_t</span> apic_base, <span class="kw4">const</span> <span class="kw4">uint8_t</span> offset, <span class="kw4">const</span> <span class="kw4">uint32_t</span> val<span class="br0">&#41;</span> 
<span class="br0">&#123;</span>
    <span class="coMULTI">/* tell IOREGSEL where we want to write to */</span>
    <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">volatile</span> <span class="kw4">uint32_t</span><span class="sy2">*</span><span class="br0">&#41;</span><span class="br0">&#40;</span>apic_base<span class="br0">&#41;</span> <span class="sy1">=</span> offset<span class="sy4">;</span>
    <span class="coMULTI">/* write the value to IOWIN */</span>
    <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">volatile</span> <span class="kw4">uint32_t</span><span class="sy2">*</span><span class="br0">&#41;</span><span class="br0">&#40;</span>apic_base <span class="sy2">+</span> <span class="nu12">0x10</span><span class="br0">&#41;</span> <span class="sy1">=</span> val<span class="sy4">;</span> 
<span class="br0">&#125;</span>
&#160;
<span class="kw4">uint32_t</span> read_ioapic_register<span class="br0">&#40;</span><span class="kw4">const</span> <span class="kw4">uintptr_t</span> apic_base, <span class="kw4">const</span> <span class="kw4">uint8_t</span> offset<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="coMULTI">/* tell IOREGSEL where we want to read from */</span>
    <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">volatile</span> <span class="kw4">uint32_t</span><span class="sy2">*</span><span class="br0">&#41;</span><span class="br0">&#40;</span>apic_base<span class="br0">&#41;</span> <span class="sy1">=</span> offset<span class="sy4">;</span>
    <span class="coMULTI">/* return the data from IOWIN */</span>
    <span class="kw1">return</span> <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">volatile</span> <span class="kw4">uint32_t</span><span class="sy2">*</span><span class="br0">&#41;</span><span class="br0">&#40;</span>apic_base <span class="sy2">+</span> <span class="nu12">0x10</span><span class="br0">&#41;</span><span class="sy4">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="coMULTI">/* @class IOAPIC
 *
 * A sample driver code which control an IOAPIC. It handles one IOAPIC and exposes
 * some functions. It is totally representational, .i.e you should add locking support
 * link all IOAPIC classes in a data structure and much more. Here we are just showing
 * what &amp; how your'e gonna handle this in C++.
 *
 * You could also note that IOAPIC registers &quot;may&quot; cross a page boundary. So maybe you
 * may need to map the physical-base to a double-page (means allocate twice the amount
 * of memory from vmm).
 */</span>
<span class="kw2">class</span> IOAPIC
<span class="br0">&#123;</span>
<span class="kw2">public</span><span class="sy4">:</span>
        <span class="kw2">enum</span> DeliveryMode
        <span class="br0">&#123;</span>
                EDGE  <span class="sy1">=</span> <span class="nu0">0</span>,
                LEVEL <span class="sy1">=</span> <span class="nu0">1</span>,
        <span class="br0">&#125;</span><span class="sy4">;</span>
&#160;
        <span class="kw2">enum</span> DestinationMode
        <span class="br0">&#123;</span>
                PHYSICAL <span class="sy1">=</span> <span class="nu0">0</span>,
                LOGICAL  <span class="sy1">=</span> <span class="nu0">1</span>
        <span class="br0">&#125;</span><span class="sy4">;</span>
&#160;
        <span class="kw4">union</span> RedirectionEntry
        <span class="br0">&#123;</span>
                <span class="kw4">struct</span>
                <span class="br0">&#123;</span>
                        <span class="kw4">uint64_t</span> vector       <span class="sy4">:</span> <span class="nu0">8</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> delvMode     <span class="sy4">:</span> <span class="nu0">3</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> destMode     <span class="sy4">:</span> <span class="nu0">1</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> delvStatus   <span class="sy4">:</span> <span class="nu0">1</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> pinPolarity  <span class="sy4">:</span> <span class="nu0">1</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> remoteIRR    <span class="sy4">:</span> <span class="nu0">1</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> triggerMode  <span class="sy4">:</span> <span class="nu0">1</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> mask         <span class="sy4">:</span> <span class="nu0">1</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> reserved     <span class="sy4">:</span> <span class="nu0">39</span><span class="sy4">;</span>
                        <span class="kw4">uint64_t</span> destination  <span class="sy4">:</span> <span class="nu0">8</span><span class="sy4">;</span>
                 <span class="br0">&#125;</span><span class="sy4">;</span>
                 <span class="kw4">struct</span>
                 <span class="br0">&#123;</span>
                        <span class="kw4">uint32_t</span> lowerDword<span class="sy4">;</span>
                        <span class="kw4">uint32_t</span> upperDword<span class="sy4">;</span>
                 <span class="br0">&#125;</span><span class="sy4">;</span>
        <span class="br0">&#125;</span><span class="sy4">;</span>
&#160;
        <span class="kw4">unsigned</span> <span class="kw4">char</span> id<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>apicId<span class="br0">&#41;</span><span class="sy4">;</span> <span class="br0">&#125;</span>
        <span class="kw4">unsigned</span> <span class="kw4">char</span> ver<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>apicVer<span class="br0">&#41;</span><span class="sy4">;</span> <span class="br0">&#125;</span>
        <span class="kw4">unsigned</span> <span class="kw4">char</span> redirectionEntries<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>redirEntryCnt<span class="br0">&#41;</span><span class="sy4">;</span> <span class="br0">&#125;</span>
        <span class="kw4">unsigned</span> <span class="kw4">long</span> globalInterruptBase<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#123;</span> <span class="kw1">return</span> <span class="br0">&#40;</span>globalIntrBase<span class="br0">&#41;</span><span class="sy4">;</span> <span class="br0">&#125;</span>
&#160;
        IOAPIC<span class="sy4">::</span><span class="me2">IOAPIC</span><span class="br0">&#40;</span><span class="kw4">unsigned</span> <span class="kw4">long</span> physRegs, <span class="kw4">unsigned</span> <span class="kw4">long</span> apicId, <span class="kw4">unsigned</span> <span class="kw4">long</span> gsib<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
                this<span class="sy2">-</span><span class="sy1">&gt;</span>virtAddr <span class="sy1">=</span> KernelMemory<span class="sy4">::</span><span class="me2">allocatePage</span><span class="br0">&#40;</span>PAGE_SIZE<span class="br0">&#41;</span><span class="sy4">;</span>
&#160;
                <span class="coMULTI">/* map virtAddr to physical-regs. Note that your paging code may not support 
                   automatically aligning physRegs to page-boundaries. Be sure to check! */</span>
                EnsureMapping<span class="br0">&#40;</span>virtAddr, physRegs, PagePresent <span class="sy3">|</span> PageReadWrite <span class="sy3">|</span> PageCacheDisable<span class="br0">&#41;</span><span class="sy4">;</span>
&#160;
               virtAddr <span class="sy2">+</span><span class="sy1">=</span> physRegs <span class="sy2">%</span> PAGE_SIZE<span class="sy4">;</span>
&#160;
               apicId <span class="sy1">=</span> <span class="br0">&#40;</span>read<span class="br0">&#40;</span>IOAPICID<span class="br0">&#41;</span> <span class="sy1">&gt;&gt;</span> <span class="nu0">24</span><span class="br0">&#41;</span> <span class="sy3">&amp;</span> <span class="nu12">0xF0</span><span class="sy4">;</span>
               apicVer <span class="sy1">=</span> read<span class="br0">&#40;</span>IOAPICVER<span class="br0">&#41;</span><span class="sy4">;</span><span class="co1">// cast to uint8_t (unsigned char) hides upper bits</span>
&#160;
               <span class="co1">//&lt; max. redir entry is given IOAPICVER[16:24]</span>
               redirEntryCnt <span class="sy1">=</span> <span class="br0">&#40;</span>read<span class="br0">&#40;</span>IOAPICVER<span class="br0">&#41;</span> <span class="sy1">&gt;&gt;</span> <span class="nu0">16</span><span class="br0">&#41;</span> <span class="sy2">+</span> <span class="nu0">1</span><span class="sy4">;</span><span class="co1">// cast to uint8_t occuring ok!</span>
               globalIntrBase <span class="sy1">=</span> gsib<span class="sy4">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="coMULTI">/*
         * Bit of assignment here - implement this on your own. Use the lowerDword &amp; upperDword
         * fields of RedirectionEntry using
         *                                 ent.lowerDword = read(entNo);
         *                                 ent.upperDword = read(entNo);
         *                                 return (ent);
         *
         * Be sure to check that entNo &lt; redirectionEntries()
         *
         * @param entNo - entry no. for which redir-entry is required
         * @return entry associated with entry no.
         */</span>
        RedirectionEntry getRedirEntry<span class="br0">&#40;</span><span class="kw4">unsigned</span> <span class="kw4">char</span> entNo<span class="br0">&#41;</span><span class="sy4">;</span>
&#160;
        <span class="coMULTI">/*
         * Bit of assignment here - implement this on your own. Use the lowerDword &amp; upperDword
         * fields of RedirectionEntry using
         *                               write(entNo, ent-&gt;lowerDword);
         *                               write(entNo, ent-&gt;upperDword);
         *
         * Be sure to check that entNo &lt; redirectionEntries()
         *
         * @param entNo - entry no. for which redir-entry is required
         * @param entry - ptr to entry to write
         */</span>
        <span class="kw4">void</span> writeRedirEntry<span class="br0">&#40;</span><span class="kw4">unsigned</span> <span class="kw4">char</span> entNo, RedirectionEntry <span class="sy2">*</span>entry<span class="br0">&#41;</span><span class="sy4">;</span>
&#160;
<span class="kw2">private</span><span class="sy4">:</span>
        <span class="coMULTI">/*
         * This field contains the physical-base address for the IOAPIC
         * can be found using an IOAPIC-entry in the ACPI 2.0 MADT.
         */</span>
        <span class="kw4">unsigned</span> <span class="kw4">long</span> physRegs<span class="sy4">;</span>
&#160;
        <span class="coMULTI">/*
         * Holds the base address of the registers in virtual memory. This
         * address is non-cacheable (see paging).
         */</span>
        <span class="kw4">unsigned</span> <span class="kw4">long</span> virtAddr<span class="sy4">;</span>
&#160;
        <span class="coMULTI">/*
         * Software has complete control over the apic-id. Also, hardware
         * won't automatically change its apic-id so we could cache it here.
         */</span>
        <span class="kw4">unsigned</span> <span class="kw4">char</span> apicId<span class="sy4">;</span>
&#160;
        <span class="coMULTI">/*
         * Hardware-version of the apic, mainly for display purpose. ToDo: specify
         * more purposes.
         */</span>
        <span class="kw4">unsigned</span> <span class="kw4">char</span> apicVer<span class="sy4">;</span>
&#160;
        <span class="coMULTI">/*
         * Although entries for current IOAPIC is 24, it may change. To retain
         * compatibility make sure you use this.
         */</span>
        <span class="kw4">unsigned</span> <span class="kw4">char</span> redirEntryCnt<span class="sy4">;</span>
&#160;
        <span class="coMULTI">/*
         * The first IRQ which this IOAPIC handles. This is only found in the
         * IOAPIC entry of the ACPI 2.0 MADT. It isn't found in the IOAPIC
         * registers.
         */</span>
        <span class="kw4">unsigned</span> <span class="kw4">long</span> globalIntrBase<span class="sy4">;</span>
&#160;
        <span class="coMULTI">/*
         * Reads the data present in the register at offset regOff.
         *
         * @param regOff - the register's offset which is being read
         * @return the data present in the register associated with that offset
         */</span>
        <span class="kw4">uint32_t</span> read<span class="br0">&#40;</span><span class="kw4">unsigned</span> <span class="kw4">char</span> regOff<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
                <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">uint32_t</span> <span class="kw4">volatile</span><span class="sy2">*</span><span class="br0">&#41;</span> virtAddr <span class="sy1">=</span> regOff<span class="sy4">;</span>
                <span class="kw1">return</span> <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">uint32_t</span> <span class="kw4">volatile</span><span class="sy2">*</span><span class="br0">&#41;</span><span class="br0">&#40;</span>virtAddr <span class="sy2">+</span> <span class="nu12">0x10</span><span class="br0">&#41;</span><span class="sy4">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="coMULTI">/*
         * Writes the data into the register associated. 
         *
         * @param regOff - the register's offset which is being written
         * @param data - dword to write to the register
         */</span>
        <span class="kw4">void</span> write<span class="br0">&#40;</span><span class="kw4">unsigned</span> <span class="kw4">char</span> regOff, <span class="kw4">uint32_t</span> data<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
                <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">uint32_t</span> <span class="kw4">volatile</span><span class="sy2">*</span><span class="br0">&#41;</span> virtAddr <span class="sy1">=</span> regOff<span class="sy4">;</span>
                <span class="sy2">*</span><span class="br0">&#40;</span><span class="kw4">uint32_t</span> <span class="kw4">volatile</span><span class="sy2">*</span><span class="br0">&#41;</span><span class="br0">&#40;</span>virtAddr <span class="sy2">+</span> <span class="nu12">0x10</span><span class="br0">&#41;</span> <span class="sy1">=</span> data<span class="sy4">;</span>
        <span class="br0">&#125;</span>
<span class="br0">&#125;</span><span class="sy4">;</span></pre></div></div>
<p>'apic_base' is the memory base address for a selected IOAPIC, these can be found by enumerating them from the MP or ACPI Tables.
</p><p><br />
</p>
<h2> <span class="mw-headline" id="IO_APIC_Inputs"> IO APIC Inputs </span></h2>
<p>How other hardware (devices, etc) use IO APIC inputs is completely arbitrary - the motherboard/chipset designer can hard-wire anything they like to any IO APIC input. For the motherboard designer's convenience, most but not all legacy IRQs are often (but not always) connected "1:1" to IO APIC inputs (e.g. IO APIC input #1 may be the same as PIC chip input #1) as this makes firmware a little easier (e.g. no need for "interrupt redirection entries" in ACPI's MASD/APIC table), but this is not a requirement of any standard and not something that useful operating system software can rely on.
</p><p>To correctly determine what how IO APIC inputs are used (and how they must be configured - as active high or active low, and as edge triggered or level triggered) operating system software must either:
</p><p>1) Use APIC's MADT/APIC table to determine how legacy IRQs are mapped to IO APIC inputs; then use ACPI's AML (with a suitable interpreter) to determine how PCI devices are connected to IO APIC inputs
</p><p>2) Use Intel's "MultiProcessor Specification" tables to determine how both legacy IRQs and PCI IRQs are mapped to IO APIC inputs. Note that Intel's "MultiProcessor Specification" is deprecated (an operating system should use ACPI where possible, and fall back to MultiProcessor Specification tables if ACPI doesn't exist or can't be used)
</p><p>3) Provide (many) motherboard specific drivers, where each driver is able to use motherboard specific information to determine how IO inputs are used
</p><p>4) Use an excessively "clever" auto-detection scheme (with a high risk of misconfiguration and race conditions). These schemes typically begin with whatever information can be obtained easily (e.g. determining legacy IRQs from ACPI's MADT/APIC table), assuming everything else can be configured as "level triggered active low" (to suit PCI), and then asking device drivers to repeatedly forcing their device to generate an IRQ (while ruling out IO APIC inputs that weren't triggered within a certain period of time after the IRQ was caused) until the specific IO APIC that the device uses can be determined.
</p><p><br />
</p>
<h2> <span class="mw-headline" id="External_Links"> External Links </span></h2>
<h3> <span class="mw-headline" id="MP_Tables"> MP Tables </span></h3>
<ul><li> <a rel="nofollow" class="external text" href="https://web.archive.org/web/20121002210153/http://download.intel.com/design/archives/processors/pro/docs/24201606.pdf">Intel MultiProcessor Specification</a>
</li></ul>
<h3> <span class="mw-headline" id="I.2FO_APIC"> I/O APIC </span></h3>
<ul><li> <a rel="nofollow" class="external text" href="http://web.archive.org/web/20161130153145/http://download.intel.com/design/chipsets/datashts/29056601.pdf">Intel 82093AA I/O APIC</a>
</li><li> <a rel="nofollow" class="external text" href="http://download.intel.com/design/processor/manuals/253668.pdf">Intel SDM 3A (see ch. 9.9)</a> (dead link)
</li></ul>

<!-- 
NewPP limit report
Preprocessor node count: 70/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key wikidb:pcache:idhash:2434-0!*!0!!en!*!* and timestamp 20210611001204 -->
</div>				<!-- /bodycontent -->
								<!-- printfooter -->
				<div class="printfooter">
				Retrieved from "<a href="https://wiki.osdev.org/index.php?title=IOAPIC&amp;oldid=23631">https://wiki.osdev.org/index.php?title=IOAPIC&amp;oldid=23631</a>"				</div>
				<!-- /printfooter -->
												<!-- catlinks -->
				<div id='catlinks' class='catlinks'><div id="mw-normal-catlinks"><a href="/Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="/Category:Interrupts" title="Category:Interrupts">Interrupts</a></li><li><a href="/Category:Multiprocessing" title="Category:Multiprocessing">Multiprocessing</a></li></ul></div></div>				<!-- /catlinks -->
												<div class="visualClear"></div>
				<!-- debughtml -->
								<!-- /debughtml -->
			</div>
			<!-- /bodyContent -->
		</div>
		<!-- /content -->
		<!-- header -->
		<div id="mw-head" class="noprint">
			
<!-- 0 -->
<div id="p-personal" class="">
	<h5>Personal tools</h5>
	<ul>
		<li id="pt-login"><a href="/index.php?title=Special:UserLogin&amp;returnto=IOAPIC" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
	</ul>
</div>

<!-- /0 -->
			<div id="left-navigation">
				
<!-- 0 -->
<div id="p-namespaces" class="vectorTabs">
	<h5>Namespaces</h5>
	<ul>
					<li  id="ca-nstab-main" class="selected"><span><a href="/IOAPIC"  title="View the content page [c]" accesskey="c">Page</a></span></li>
					<li  id="ca-talk" class="new"><span><a href="/index.php?title=Talk:IOAPIC&amp;action=edit&amp;redlink=1"  title="Discussion about the content page [t]" accesskey="t">Discussion</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-variants" class="vectorMenu emptyPortlet">
		<h5><span>Variants</span><a href="#"></a></h5>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->
			</div>
			<div id="right-navigation">
				
<!-- 0 -->
<div id="p-views" class="vectorTabs">
	<h5>Views</h5>
	<ul>
					<li id="ca-view" class="selected"><span><a href="/IOAPIC" >Read</a></span></li>
					<li id="ca-viewsource"><span><a href="/index.php?title=IOAPIC&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
					<li id="ca-history" class="collapsible"><span><a href="/index.php?title=IOAPIC&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-cactions" class="vectorMenu emptyPortlet">
	<h5><span>Actions</span><a href="#"></a></h5>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->

<!-- 2 -->
<div id="p-search">
	<h5><label for="searchInput">Search</label></h5>
	<form action="/index.php" id="searchform">
		<input type='hidden' name="title" value="Special:Search"/>
				<input type="search" name="search" title="Search OSDev Wiki [f]" accesskey="f" id="searchInput" />		<input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchGoButton" class="searchButton" />		<input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton" />			</form>
</div>

<!-- /2 -->
			</div>
		</div>
		<!-- /header -->
		<!-- panel -->
			<div id="mw-panel" class="noprint">
				<!-- logo -->
					<div id="p-logo"><a style="background-image: url(/skins/common/images/osdev.png);" href="/Main_Page"  title="Visit the main page"></a></div>
				<!-- /logo -->
				
<!-- navigation -->
<div class="portal" id='p-navigation'>
	<h5>Navigation</h5>
	<div class="body">
		<ul>
			<li id="n-mainpage"><a href="/Main_Page" title="Visit the main page [z]" accesskey="z">Main Page</a></li>
			<li id="n-portal"><a href="http://forum.osdev.org/" rel="nofollow" title="About the project, what you can do, where to find things">Forums</a></li>
			<li id="n-FAQ"><a href="/Category:FAQ">FAQ</a></li>
			<li id="n-OS-Projects"><a href="/Projects">OS Projects</a></li>
			<li id="n-randompage"><a href="/Special:Random" title="Load a random page [x]" accesskey="x">Random page</a></li>
		</ul>
	</div>
</div>

<!-- /navigation -->

<!-- about -->
<div class="portal" id='p-about'>
	<h5>About</h5>
	<div class="body">
		<ul>
			<li id="n-This-site"><a href="/OSDevWiki:About">This site</a></li>
			<li id="n-Joining"><a href="/OSDevWiki:Joining">Joining</a></li>
			<li id="n-Editing-help"><a href="/OSDevWiki:Editing">Editing help</a></li>
			<li id="n-recentchanges"><a href="/Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li>
		</ul>
	</div>
</div>

<!-- /about -->

<!-- SEARCH -->

<!-- /SEARCH -->

<!-- TOOLBOX -->
<div class="portal" id='p-tb'>
	<h5>Toolbox</h5>
	<div class="body">
		<ul>
			<li id="t-whatlinkshere"><a href="/Special:WhatLinksHere/IOAPIC" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
			<li id="t-recentchangeslinked"><a href="/Special:RecentChangesLinked/IOAPIC" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
			<li id="t-specialpages"><a href="/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
			<li><a href="/index.php?title=IOAPIC&amp;printable=yes" rel="alternate">Printable version</a></li>
			<li id="t-permalink"><a href="/index.php?title=IOAPIC&amp;oldid=23631" title="Permanent link to this revision of the page">Permanent link</a></li>
		</ul>
	</div>
</div>

<!-- /TOOLBOX -->

<!-- LANGUAGES -->
<div class="portal" id='p-lang'>
	<h5>In other languages</h5>
	<div class="body">
		<ul>
			<li class="interwiki-de"><a href="http://www.lowlevel.eu/wiki/I/O_Advanced_Programmable_Interrupt_Controller" title="I/O Advanced Programmable Interrupt Controller">Deutsch</a></li>
		</ul>
	</div>
</div>

<!-- /LANGUAGES -->
			</div>
		<!-- /panel -->
		<!-- footer -->
		<div id="footer">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> This page was last modified on 19 May 2019, at 11:39.</li>
											<li id="footer-info-viewcount">This page has been accessed 99,163 times.</li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="/OSDev_Wiki:Privacy_policy" title="OSDev Wiki:Privacy policy">Privacy policy</a></li>
											<li id="footer-places-about"><a href="/OSDev_Wiki:About" title="OSDev Wiki:About">About OSDev Wiki</a></li>
											<li id="footer-places-disclaimer"><a href="/OSDev_Wiki:General_disclaimer" title="OSDev Wiki:General disclaimer">Disclaimers</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
					<li id="footer-poweredbyico">
						<a href="http://www.mediawiki.org/"><img src="/skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
					</li>
				</ul>
						<div style="clear:both"></div>
		</div>
		<!-- /footer -->
		<!-- fixalpha -->
		<script type="text/javascript"> if ( window.isMSIE55 ) fixalpha(); </script>
		<!-- /fixalpha -->
		<script src="/load.php?debug=false&amp;lang=en&amp;modules=skins.vector&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
	mw.loader.load(["mediawiki.user", "mediawiki.util", "mediawiki.page.ready", "mediawiki.legacy.wikibits", "mediawiki.legacy.ajax"]);
}
</script>
<script src="/load.php?debug=false&amp;lang=en&amp;modules=site&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
	mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"externaldiff":0,"externaleditor":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"highlightbroken":1,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"quickbar":5,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"showjumplinks":1,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"vector","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":0,"watchdefault":0,"watchdeletion":0,"watchlistdays":3,"watchlisthideanons":0,
	"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"variant":"en","language":"en","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false});;mw.user.tokens.set({"editToken":"+\\","watchToken":false});;mw.loader.state({"user.options":"ready","user.tokens":"ready"});
	
	/* cache key: wikidb:resourceloader:filter:minify-js:4:19a4b18a9ac79a6b8c60b24af4668814 */
}
</script><!-- Served in 0.037 secs. -->
	</body>
</html>
